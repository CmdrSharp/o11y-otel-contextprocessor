# Context Processor

<!-- status autogenerated section -->
| Status        |           |
| ------------- |-----------|
| Stability     | [alpha]: traces, metrics, logs   |
| Distributions | [contrib] |
| Warnings      | [Identity Conflict](#warnings) |
| [Code Owners](https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/CONTRIBUTING.md#becoming-a-code-owner)    | [@jriguera](https://www.github.com/jriguera) |

[beta]: https://github.com/open-telemetry/opentelemetry-collector#alpha
[core]: https://github.com/open-telemetry/opentelemetry-collector-releases/tree/main/distributions/otelcol
[contrib]: https://github.com/open-telemetry/opentelemetry-collector-releases/tree/main/distributions/otelcol-contrib
<!-- end autogenerated section -->

## Description

The context processor modifies context metadata of a span, log, or metric. Please refer to
[config.go](./config.go) for the config spec.

Typical use cases:

* Be able to dynamically define tenants for Mimir/Cortex.
* Dynamically define metadata attributes in the context, to offer a link to pass resource attribute to extensions
* Change metadata generated from the receivers

## Configuration

It takes a list of actions which are performed in order specified in the config.
The supported actions are:
- `insert`: Inserts a new attribute in input data where the key does not already exist.
- `update`: Updates an attribute in input data where the key does exist.
- `upsert`: Performs insert or update. Inserts a new attribute in input data where the
  key does not already exist and updates an attribute in input data where the key
  does exist.
- `delete`: Deletes an attribute from the input data.

For the actions `insert`, `update` and `upsert`,
 - `key`  is required
 - `value` and/or `from_attribute` are required
 - `action` is required.
```yaml
  # Key specifies the attribute to act upon.
- key: <key>
  action: {insert, update, upsert}
  # Value specifies the value to populate for the key.
  value: <value>

  # Key specifies the attribute to act upon.
- key: <key>
  action: {insert, update, upsert}
  # FromAttribute specifies the attribute from the context metadata to use to populate
  # the value. If the attribute doesn't exist, value is used.
  from_attribute: <other key>
  value: <value>
```

For the `delete` action,
 - `key` is required
 - `action: delete` is required.
```yaml
# Key specifies the attribute to act upon.
- key: <key>
  action: delete
```

The list of actions can be composed to create rich scenarios, such as
back filling attribute, copying values to a new key, redacting sensitive information.
The following is a sample configuration.

```yaml
processors:
  context/example:
    actions:
    - action: upsert
      key: tenant
      value: anonymous
      from_attribute: service.name
    - action: delete
      key: tenant
```

## Usage

It is **highly** recommended to use this processor with `groupbyattrs` and `groupbytrace` processors together, potentially the batch processor can be used.

```yaml
extensions:
  headers_setter:
    headers:
      - action: update
        key: X-Scope-OrgID
        from_context: tenant

processors:
  batch/tenant:

  groupbyattrs/tenant:
    keys: [tenant]

  context/tenant:
    actions:
    - action: upsert
      key: tenant
      value: anonymous
      from_attribute: tenant

exporters:
  prometheusremotewrite/mimir:
    endpoint: "http://mimir-gateway/api/v1/push"
    resource_to_telemetry_conversion:
      enabled: true
    auth:
      authenticator: headers_setter

pipelines:
  metrics:
    receivers: [ ... ]
    processors: [batch/tenant, groupbyattrs/tenant, context/tenant]
    exporters: [prometheusremotewrite/mimir]
  extensions: 
  - headers_setter
```


## Warnings

In general, the Context processor is a very safe processor to use. But should be used after an [Group by Attributes processor](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/groupbyattrsprocessor)
